# Вариант 3: CRM и Воронка Продаж

### Легенда
Вы разрабатываете базу данных для CRM-системы, чтобы отслеживать процесс продаж. Система должна хранить информацию о компаниях-клиентах, менеджерах по продажам и сделках, которые находятся на разных этапах воронки продаж.

*   **`Companies` (Компании):** информация о потенциальных или существующих клиентах (название, отрасль, контактное лицо).
*   **`Salespersons` (Менеджеры по продажам):** данные о сотрудниках, ответственных за ведение сделок.
*   **`Deals` (Сделки):** связующая сущность, которая фиксирует потенциальную продажу. Каждая сделка связана с компанией, ведется определенным менеджером и имеет сумму и текущий этап в воронке продаж.

---
### Задание 1: Проектирование и реализация (10 баллов)
1.  **Создайте ER-диаграмму** для таблиц `Companies`, `Salespersons`, `Deals`. Определите атрибуты, типы данных, первичные и внешние ключи.
2.  **Напишите SQL-скрипт (`CREATE TABLE`)** для создания таблиц. Включите ограничения `PRIMARY KEY`, `FOREIGN KEY`, `NOT NULL`, а также используйте `ENUM` для этапа сделки (`stage`) со значениями `'lead'`, `'qualified'`, `'proposal'`, `'won'`, `'lost'` и установите `DEFAULT 'lead'`.
3.  **Письменно обоснуйте**, почему ваша схема находится в **третьей нормальной форме (3NF)**.

---
### Задание 2: Работа с данными и сложные запросы (10 баллов)
1.  Наполните таблицы тестовыми данными (5 компаний, 3 менеджера, 15 сделок на разных этапах).
2.  **Напишите SQL-запросы:**
    *   **Простой `SELECT`:** Найти все сделки на сумму более 500,000, находящиеся на этапе 'proposal'.
    *   **`UPDATE`:** Перевести сделку на следующий этап: изменить ее `stage` с 'proposal' на 'won'.
    *   **`SELECT` с `INNER JOIN`:** Вывести список всех активных сделок (название компании, сумма сделки), которые ведет менеджер "Иванов Иван".
    *   **`SELECT` с `LEFT JOIN`:** Вывести список **всех** менеджеров и общую сумму выигранных ими сделок (`stage = 'won'`). Менеджеры без выигранных сделок также должны быть в списке (с суммой 0).
    *   **`SELECT` с `GROUP BY` и `HAVING`:** Найти компании, с которыми было заключено более одной успешной сделки (`stage = 'won'`).
    *   **Сложный запрос:** Найти самого успешного менеджера по общей сумме выигранных сделок.

---
### Задание 3: Оптимизация и анализ схемы (10 баллов)
1.  **Анализ запроса:** Выполните `EXPLAIN` для запроса поиска компании по части названия (`... WHERE company_name LIKE '%строй%'`). Объясните, почему он приводит к полному сканированию таблицы и является неэффективным.
2.  **Создание индекса:** Создайте индекс для поля `industry` (отрасль) в таблице `Companies` для ускорения поиска клиентов из определенной отрасли. Напишите команду `CREATE INDEX`.
3.  **Реверс-инжиниринг:** Сгенерируйте схему вашей БД с помощью DBeaver или аналога.
4.  **Сравнение:** Сравните сгенерированную схему с вашей исходной ER-диаграммой и опишите различия (если они есть).

***
